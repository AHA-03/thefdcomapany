<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Order System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .qty-controls {
            display: flex;
            align-items: center;
        }
        button {
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
        }
        #order-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            margin-top: 20px;
        }
        #confirmation {
            display: none;
            text-align: center;
        }
        #qr-code {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="card">
        <h2>Place Your Order</h2>
        
        <div>
            <label>Roll Number (6 digits):</label>
            <input type="text" id="roll_number" pattern="\d{6}" required>
        </div>
        
        <div>
            <label>Phone Number (10 digits):</label>
            <input type="text" id="phone_number" pattern="\d{10}" required>
        </div>
        
        <h3>Menu</h3>
        <div id="food-list">
            <!-- Food items will be added by JavaScript -->
        </div>
        
        <button id="order-btn">Place Order</button>
    </div>

    <div class="card" id="confirmation">
        <h2>Order Confirmed!</h2>
        <p>Booking ID: <strong id="booking-id"></strong></p>
        <div id="qr-code"></div>
        <p>Show this QR code at the counter</p>
    </div>

    <script>
        // Menu data
        const menuItems = [
            { food_item: "Tomato Rice", price: 60, weight: 600 },
            { food_item: "Biryani", price: 90, weight: 800 },
            { food_item: "Curd Rice", price: 40, weight: 500 }
        ];

        // Initialize menu
        function initMenu() {
            const foodList = document.getElementById('food-list');
            
            menuItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'food-item';
                div.innerHTML = `
                    <span>${item.food_item} (â‚¹${item.price})</span>
                    <div class="qty-controls">
                        <button onclick="adjustQty(this, -1)">-</button>
                        <span class="qty">0</span>
                        <button onclick="adjustQty(this, 1)">+</button>
                    </div>
                    <input type="hidden" class="price" value="${item.price}">
                    <input type="hidden" class="weight" value="${item.weight}">
                    <input type="hidden" class="name" value="${item.food_item}">
                `;
                foodList.appendChild(div);
            });
        }

        // Adjust quantity
        function adjustQty(button, change) {
            const qtyElement = button.parentElement.querySelector('.qty');
            let qty = parseInt(qtyElement.textContent) + change;
            qty = qty < 0 ? 0 : qty;
            qtyElement.textContent = qty;
        }

        // Place order
        document.getElementById('order-btn').addEventListener('click', async function() {
            const rollNumber = document.getElementById('roll_number').value;
            const phoneNumber = document.getElementById('phone_number').value;
            
            // Validate inputs
            if (!/^\d{6}$/.test(rollNumber)) {
                alert('Please enter a valid 6-digit roll number');
                return;
            }
            
            if (!/^\d{10}$/.test(phoneNumber)) {
                alert('Please enter a valid 10-digit phone number');
                return;
            }
            
            // Collect order items
            const foodItems = [];
            document.querySelectorAll('.food-item').forEach(item => {
                const qty = parseInt(item.querySelector('.qty').textContent);
                if (qty > 0) {
                    foodItems.push({
                        food_item: item.querySelector('.name').value,
                        price: parseInt(item.querySelector('.price').value),
                        quantity: qty,
                        weight: parseInt(item.querySelector('.weight').value)
                    });
                }
            });
            
            if (foodItems.length === 0) {
                alert('Please select at least one food item');
                return;
            }
            
            // Disable button during processing
            const orderBtn = document.getElementById('order-btn');
            orderBtn.disabled = true;
            orderBtn.textContent = 'Processing...';
            
            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        roll_number: rollNumber,
                        phone_number: phoneNumber,
                        food_items: foodItems
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Show confirmation
                    document.getElementById('booking-id').textContent = result.booking_id;
                    document.getElementById('qr-code').innerHTML = 
                        `<img src="data:image/png;base64,${result.qr_code}" width="150" height="150">`;
                    document.getElementById('confirmation').style.display = 'block';
                    window.scrollTo(0, document.body.scrollHeight);
                } else {
                    alert(result.error || 'Failed to place order');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                orderBtn.disabled = false;
                orderBtn.textContent = 'Place Order';
            }
        });

        // Initialize the page
        document.addEventListener('DOMContentLoaded', initMenu);
    </script>
</body>
</html>